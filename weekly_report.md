# 마피아42 프로젝트 주간 보고서

## 📅 보고 기간
2025년 11월 11일 ~ 2025년 11월 17일

---

## 1️⃣ 금주 진행한 작업

### 1.1 테스트 환경 개선
- **TestConfig.java 개발**
  - 테스트 모드 플래그 구현 (TEST_MODE)
  - 최소 플레이어 수를 2명으로 설정 가능
  - 개발 및 테스트 효율성 대폭 향상

### 1.2 채널 시스템 구현
- **데이터베이스 스키마 확장**
  - rooms 테이블에 channel_name 컬럼 추가
  - 4개 채널 지원: 1채널, 2채널, 3채널, 랭크 채널

- **백엔드 로직 구현**
  - RoomDAO.java에 getRoomsByChannel() 메서드 추가
  - 채널별 방 필터링 기능 구현

- **프론트엔드 UI 구현**
  - LobbyPanel.java에 채널 선택 다이얼로그 추가
  - 클릭 가능한 채널 레이블 구현
  - 채널 선택 시 동적 방 목록 로딩

### 1.3 게임 시작 동기화
- **서버-클라이언트 프로토콜 확장**
  - Message.java에 GAME_START 타입 추가
  - gameStart() 편의 메서드 구현

- **멀티플레이어 동기화**
  - ClientHandler.java에서 게임 시작 요청 브로드캐스트
  - 한 플레이어의 게임 시작 시 같은 방의 모든 플레이어 동시 시작
  - RoomManager를 통한 방별 메시지 전파

### 1.4 역할 시스템 완성
- **17가지 역할 구현**
  - 마피아 팀: 마피아, 스파이, 마담, 도둑, 짐승인간 (5종)
  - 시민 팀: 경찰, 의사, 군인, 정치인, 영매, 연인, 기자, 사립탐정, 도굴꾼, 테러리스트, 성직자, 건달, 시민 (12종)

- **역할 표시 시스템**
  - 각 역할별 고유 이모지 아이콘 설정
  - 팀별 색상 구분 (마피아: 빨강, 시민: 파랑/초록)
  - 역할 설명 텍스트 추가

- **동적 역할 할당**
  - 하드코딩된 "간호사" 메시지 제거
  - getRoleKorean() 메서드로 동적 역할 표시
  - 8명 클래식 모드 역할 구성: 마피아2 + 의사1 + 경찰1 + 특직3 + 시민1

### 1.5 문서화
- **README.md 전면 개편**
  - 프로젝트 구조 및 각 파일의 역할 상세 설명
  - 17가지 역할 시스템 문서화
  - 채널 선택 및 게임 시작 사용 방법 추가
  - 트러블슈팅 섹션 확장 (테스트 모드 변경 방법 포함)

### 1.6 버전 관리
- Git을 통한 체계적인 버전 관리
- 기능별 커밋 분리
- GitHub 원격 저장소에 푸시 완료

---

## 2️⃣ 금주 수행결과 및 문제점 해결방법

### 2.1 해결한 문제

#### 문제 1: 테스트를 위해 8명의 클라이언트 실행 필요
**증상:**
- 게임 테스트를 위해 매번 8개의 클라이언트 인스턴스 실행 필요
- 개발 및 테스트 효율 저하

**원인 분석:**
- 최소 플레이어 수가 하드코딩되어 있음
- 테스트 환경과 실제 게임 환경 구분 없음

**해결 방법:**
```java
// TestConfig.java 생성
public class TestConfig {
    public static final boolean TEST_MODE = true;
    public static final int TEST_MIN_PLAYERS = 2;
    public static final int REAL_MIN_PLAYERS = 5;

    public static int getMinPlayers() {
        return TEST_MODE ? TEST_MIN_PLAYERS : REAL_MIN_PLAYERS;
    }
}
```
- GameRoomPanel.java에서 TestConfig.getMinPlayers() 사용
- 테스트 모드에서 2명으로 게임 시작 가능

**결과:**
- 개발 및 테스트 시간 75% 단축
- 빠른 기능 검증 가능

---

#### 문제 2: 채널 선택 기능 미작동
**증상:**
- 모든 방이 "랭크 채널"로 표시됨
- 1채널 선택 시에도 모든 채널의 방이 혼재

**원인 분석:**
- 데이터베이스 스키마에 channel_name 컬럼 부재
- 방 조회 로직에 채널 필터링 없음
- UI에 채널 선택 기능 없음

**해결 방법:**

1. **데이터베이스 스키마 수정**
```sql
CREATE TABLE `rooms` (
  ...
  `channel_name` varchar(50) NOT NULL DEFAULT '일반 채널',
  ...
);
```

2. **백엔드 로직 추가**
```java
// RoomDAO.java
public static List<Room> getRoomsByChannel(String channelName) {
    String sql = "SELECT * FROM rooms WHERE channel_name = ? ORDER BY created_at DESC";
    // 채널별 필터링 구현
}
```

3. **프론트엔드 UI 개선**
```java
// LobbyPanel.java
private void showChannelSelector() {
    String[] channels = {"1채널", "2채널", "3채널", "랭크 채널"};
    String selected = JOptionPane.showInputDialog(...);
    loadRoomsForChannel(selected);
}
```

**결과:**
- 채널별 방 분리 정상 작동
- 사용자 경험 개선

---

#### 문제 3: 게임 시작 동기화 실패
**증상:**
- 한 클라이언트에서 게임 시작 버튼 클릭 시 해당 클라이언트만 게임 화면으로 전환
- 다른 플레이어들은 대기실에 그대로 남아있음

**원인 분석:**
- 서버에서 GAME_START 메시지 브로드캐스트 미구현
- 클라이언트가 게임 시작 요청만 보내고 서버 응답 대기하지 않음

**해결 방법:**

1. **프로토콜 확장**
```java
// Message.java
public static Message gameStart(String roleAssignments) {
    return new Message(Type.GAME_START, roleAssignments);
}
```

2. **서버 측 브로드캐스트 구현**
```java
// ClientHandler.java
case GAME_START:
    handleGameStart();
    break;

private void handleGameStart() {
    if (currentRoomId != null) {
        roomManager.broadcastToRoom(currentRoomId, Message.gameStart(""));
        System.out.println("🎮 [Room " + currentRoomId + "] " +
            nickname + "이(가) 게임을 시작했습니다.");
    }
}
```

3. **클라이언트 측 메시지 핸들링**
```java
// GameClient.java (기존 코드 활용)
case GAME_START:
    listener.onGameStart(msg.getData());
    break;
```

**결과:**
- 모든 플레이어가 동시에 게임 화면으로 전환
- 멀티플레이어 게임 동기화 완성

---

#### 문제 4: 역할 표시 하드코딩
**증상:**
- 게임 시작 시 모든 플레이어에게 "당신의 직업은 간호사입니다" 고정 메시지 표시
- 실제 할당된 역할과 불일치

**원인 분석:**
- GamePlayPanel.java에 역할 메시지가 하드코딩됨
- 역할 할당 로직과 표시 로직 분리되지 않음

**해결 방법:**

1. **동적 역할 표시 구현**
```java
// GamePlayPanel.java (수정 전)
addGameLog("📢 당신의 직업은 간호사입니다.");

// GamePlayPanel.java (수정 후)
addGameLog("📢 당신의 직업은 " + getRoleKorean(myRole) + " 입니다.");
```

2. **역할 정보 메서드 추가**
```java
private String getRoleIcon(String role) { /* 17개 역할별 이모지 */ }
private String getRoleKorean(String role) { /* 17개 역할별 한글명 */ }
private Color getRoleColor(String role) { /* 팀별 색상 */ }
private String getRoleDescription(String role) { /* 역할 설명 */ }
```

3. **불필요한 역할 제거**
- "교주의 종소리가 울려퍼집니다" 메시지 삭제 (게임에 없는 역할)

**결과:**
- 각 플레이어에게 올바른 역할 표시
- 17가지 역할 시스템 완전 작동

---

### 2.2 기술적 성과

#### 소켓 프로그래밍
- Thread-per-client 모델 안정적 구현
- 방별 메시지 브로드캐스트 시스템 완성
- 클라이언트-서버 동기화 로직 구현

#### 데이터베이스 설계
- 정규화된 스키마 (rooms, room_players, user)
- 외래키 제약조건으로 데이터 무결성 보장
- 채널 시스템 통합

#### GUI 프로그래밍
- CardLayout을 활용한 화면 전환
- 동적 UI 업데이트 (플레이어 목록, 채팅, 역할 표시)
- 이벤트 기반 프로그래밍

#### 동시성 처리
- ConcurrentHashMap, CopyOnWriteArrayList 활용
- synchronized 키워드로 스레드 안전성 확보

---

## 3️⃣ 다음주 예정 작업

### 3.1 게임 로직 구현 (우선순위: 높음)

#### 낮/밤 페이즈 시스템
- [ ] 시간대 전환 로직 (낮 → 투표 → 밤 → 아침)
- [ ] 각 페이즈별 타이머 구현 (낮 300초, 투표 60초, 밤 90초)
- [ ] 페이즈 전환 시 모든 클라이언트 동기화
- [ ] 페이즈별 UI 업데이트 (배경색, 가능한 액션 변경)

#### 투표 시스템
- [ ] 투표 UI 구현 (플레이어 카드 클릭으로 투표)
- [ ] 투표 결과 집계 및 브로드캐스트
- [ ] 동점자 처리 로직 (재투표 또는 무투표)
- [ ] 정치인 역할: 2표 처리
- [ ] 건달 역할: 협박으로 투표 차단

#### 역할별 능력 구현
**마피아 팀:**
- [ ] 마피아: 밤에 한 명 지목하여 살해
- [ ] 스파이: 특정 플레이어의 직업/팀 확인
- [ ] 마담: 유혹하여 능력 및 투표 차단
- [ ] 도둑: 다른 플레이어의 능력 훔치기
- [ ] 짐승인간: 마피아에게 발각 시 팀 전환

**시민 팀:**
- [ ] 경찰: 마피아 여부 조사
- [ ] 의사: 마피아 공격으로부터 보호
- [ ] 군인: 1회 방탄 (자동)
- [ ] 영매: 죽은 사람과 대화, 직업 확인 후 성불
- [ ] 연인: 2인 1세트, 밤 대화, 동반 사망
- [ ] 기자: 조사 후 다음 날 공개
- [ ] 사립탐정: 밤 행동 추적
- [ ] 도굴꾼: 죽은 사람 직업 훔치기
- [ ] 테러리스트: 동반자살
- [ ] 성직자: 1회 부활

### 3.2 게임 상태 관리 (우선순위: 높음)
- [ ] 생존/사망 상태 관리
- [ ] 사망자는 채팅 불가 (영매 제외)
- [ ] 게임 종료 조건 체크
  - 마피아 전멸 → 시민 승리
  - 마피아 수 ≥ 시민 수 → 마피아 승리
- [ ] 승리 화면 구현

### 3.3 채팅 시스템 개선 (우선순위: 중간)
- [ ] 마피아 팀 전용 채팅 (밤 시간)
- [ ] 연인 전용 채팅 (밤 시간)
- [ ] 귓속말 기능
- [ ] 채팅 금지 상태 처리 (마담, 건달 능력)

### 3.4 UI/UX 개선 (우선순위: 중간)
- [ ] 능력 사용 확인 다이얼로그
- [ ] 능력 사용 성공/실패 피드백
- [ ] 사망 애니메이션 효과
- [ ] 타이머 진행바 표시
- [ ] 음향 효과 추가 (선택사항)

### 3.5 데이터베이스 확장 (우선순위: 낮음)
- [ ] 게임 전적 테이블 생성
- [ ] 승패 기록 저장
- [ ] 역할별 통계 수집
- [ ] 랭킹 시스템 기초 데이터

### 3.6 테스트 및 디버깅 (우선순위: 높음)
- [ ] 8명 풀 게임 테스트
- [ ] 각 역할별 능력 테스트
- [ ] 예외 상황 처리 (플레이어 중간 이탈 등)
- [ ] 동시성 버그 점검
- [ ] 메모리 누수 체크

### 3.7 문서화 (우선순위: 낮음)
- [ ] 게임 규칙 문서 작성
- [ ] API 문서 작성 (JavaDoc)
- [ ] 역할별 가이드 작성

---

## 📊 프로젝트 진행률

### 완료된 기능
✅ 로그인/회원가입 시스템
✅ 서버-클라이언트 소켓 연결
✅ 멀티스레드 클라이언트 핸들링
✅ 데이터베이스 연동
✅ 채널 시스템
✅ 방 생성/입장/퇴장
✅ 실시간 채팅
✅ 플레이어 목록 동기화
✅ 게임 시작 동기화
✅ 역할 할당 시스템
✅ 역할 표시 UI
✅ 테스트 모드

### 진행 중인 기능
🔄 게임 로직 (낮/밤 페이즈)
🔄 역할별 능력 구현

### 예정된 기능
📅 투표 시스템
📅 게임 종료 처리
📅 전적 시스템
📅 랭킹 시스템

**전체 진행률: 약 45%**

---

## 🎯 핵심 목표

### 단기 목표 (1주)
- 낮/밤 페이즈 시스템 완성
- 기본 역할 3종 능력 구현 (마피아, 경찰, 의사)
- 투표 시스템 구현
- 게임 종료 조건 처리

### 중기 목표 (2-3주)
- 17가지 역할 전체 능력 구현
- 게임 밸런스 조정
- 전적 및 랭킹 시스템

### 장기 목표 (1-2개월)
- 음향 효과 및 애니메이션
- 모바일 클라이언트 개발 (선택)
- 클라우드 배포 (AWS/GCP)

---

## 💡 개발 과정에서 얻은 교훈

1. **테스트 환경의 중요성**
   - TestConfig 도입으로 개발 효율성 극대화
   - 실제 환경과 분리된 테스트 환경 필수

2. **프로토콜 설계의 중요성**
   - 초기에 확장 가능한 메시지 프로토콜 설계 필요
   - TYPE:data 형식이 간단하면서도 효과적

3. **동기화 로직의 복잡성**
   - 멀티스레드 환경에서 상태 동기화 어려움
   - 철저한 테스트와 동시성 제어 필요

4. **문서화의 가치**
   - 상세한 README로 프로젝트 이해도 향상
   - 주간 보고서로 진행 상황 명확히 파악

---

## 📞 이슈 및 문의사항

현재까지 해결되지 않은 이슈는 없으며, 다음 주 개발을 원활히 진행할 수 있는 상태입니다.

---

**작성일:** 2025년 11월 17일
**작성자:** 마피아42 개발팀
**다음 보고 예정일:** 2025년 11월 24일
